<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.jerrychu.top","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="ä¸Šä¸€ç¯‡æ–‡ç«  ä»‹ç»äº†å¦‚ä½•è·å– NSTimerï¼ˆFBObjectiveCNSCFTimerï¼‰çš„æ‰€æœ‰å¼ºå¼•ç”¨å¯¹è±¡ã€‚æœ¬æ–‡ç»§ç»­ä»‹ç»å¦‚ä½•è·å–ä¸€ç§ç‰¹æ®ŠOCå¯¹è±¡ â€“ Block çš„æ‰€æœ‰å¼ºå¼•ç”¨å¯¹è±¡ã€‚ åœ¨ FBRetainCycleDetector çš„æºç ä¸­ï¼ŒBlock å¯¹åº”çš„ç±»ä¸º FBObjectiveCBlockã€‚  FBRetainCycleDetector æºç åœ°å€ï¼š https:&#x2F;&#x2F;github.com&#x2F;fa">
<meta property="og:type" content="article">
<meta property="og:title" content="è·å–OCå¯¹è±¡çš„æ‰€æœ‰å¼ºå¼•ç”¨å¯¹è±¡ï¼ˆä¸‰ï¼‰">
<meta property="og:url" content="http://blog.jerrychu.top/2021/01/23/%E8%8E%B7%E5%8F%96OC%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%89%80%E6%9C%89%E5%BC%BA%E5%BC%95%E7%94%A8%E5%AF%B9%E8%B1%A13/index.html">
<meta property="og:site_name" content="++">
<meta property="og:description" content="ä¸Šä¸€ç¯‡æ–‡ç«  ä»‹ç»äº†å¦‚ä½•è·å– NSTimerï¼ˆFBObjectiveCNSCFTimerï¼‰çš„æ‰€æœ‰å¼ºå¼•ç”¨å¯¹è±¡ã€‚æœ¬æ–‡ç»§ç»­ä»‹ç»å¦‚ä½•è·å–ä¸€ç§ç‰¹æ®ŠOCå¯¹è±¡ â€“ Block çš„æ‰€æœ‰å¼ºå¼•ç”¨å¯¹è±¡ã€‚ åœ¨ FBRetainCycleDetector çš„æºç ä¸­ï¼ŒBlock å¯¹åº”çš„ç±»ä¸º FBObjectiveCBlockã€‚  FBRetainCycleDetector æºç åœ°å€ï¼š https:&#x2F;&#x2F;github.com&#x2F;fa">
<meta property="article:published_time" content="2021-01-23T08:14:26.000Z">
<meta property="article:modified_time" content="2021-01-23T10:45:24.630Z">
<meta property="article:author" content="JerryChu">
<meta property="article:tag" content="iOS">
<meta property="article:tag" content="Performance">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://blog.jerrychu.top/2021/01/23/%E8%8E%B7%E5%8F%96OC%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%89%80%E6%9C%89%E5%BC%BA%E5%BC%95%E7%94%A8%E5%AF%B9%E8%B1%A13/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>è·å–OCå¯¹è±¡çš„æ‰€æœ‰å¼ºå¼•ç”¨å¯¹è±¡ï¼ˆä¸‰ï¼‰ | ++</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">++</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home                          //é¦–é¡µ fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive          //å½’æ¡£ fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags                     //æ ‡ç­¾ fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user                   //å…³äº fa-fw"></i>About</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/jerrychu" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.jerrychu.top/2021/01/23/%E8%8E%B7%E5%8F%96OC%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%89%80%E6%9C%89%E5%BC%BA%E5%BC%95%E7%94%A8%E5%AF%B9%E8%B1%A13/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="JerryChu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="++">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          è·å–OCå¯¹è±¡çš„æ‰€æœ‰å¼ºå¼•ç”¨å¯¹è±¡ï¼ˆä¸‰ï¼‰
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-01-23 16:14:26 / Modified: 18:45:24" itemprop="dateCreated datePublished" datetime="2021-01-23T16:14:26+08:00">2021-01-23</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><a href="https://blog.jerrychu.top/2021/01/16/%E8%8E%B7%E5%8F%96OC%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%89%80%E6%9C%89%E5%BC%BA%E5%BC%95%E7%94%A8%E5%AF%B9%E8%B1%A12/">ä¸Šä¸€ç¯‡æ–‡ç« </a> ä»‹ç»äº†å¦‚ä½•è·å– NSTimerï¼ˆ<code>FBObjectiveCNSCFTimer</code>ï¼‰çš„æ‰€æœ‰å¼ºå¼•ç”¨å¯¹è±¡ã€‚æœ¬æ–‡ç»§ç»­ä»‹ç»å¦‚ä½•è·å–ä¸€ç§ç‰¹æ®ŠOCå¯¹è±¡ â€“ <code>Block</code> çš„æ‰€æœ‰å¼ºå¼•ç”¨å¯¹è±¡ã€‚</p>
<p>åœ¨ <a href="https://github.com/facebook/FBRetainCycleDetector" target="_blank" rel="noopener">FBRetainCycleDetector</a> çš„æºç ä¸­ï¼Œ<code>Block</code> å¯¹åº”çš„ç±»ä¸º <code>FBObjectiveCBlock</code>ã€‚</p>
<blockquote>
<p>FBRetainCycleDetector æºç åœ°å€ï¼š <a href="https://github.com/facebook/FBRetainCycleDetector" target="_blank" rel="noopener">https://github.com/facebook/FBRetainCycleDetector</a></p>
</blockquote>
<h2 id="Block-åŸºç¡€"><a href="#Block-åŸºç¡€" class="headerlink" title="Block åŸºç¡€"></a>Block åŸºç¡€</h2><p>OC çš„ Block å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> BlockLiteral &#123;</span><br><span class="line">  <span class="keyword">void</span> *isa;  <span class="comment">// initialized to &amp;_NSConcreteStackBlock or &amp;_NSConcreteGlobalBlock</span></span><br><span class="line">  <span class="keyword">int</span> flags;</span><br><span class="line">  <span class="keyword">int</span> reserved;</span><br><span class="line">  <span class="keyword">void</span> (*invoke)(<span class="keyword">void</span> *, ...);</span><br><span class="line">  <span class="keyword">struct</span> BlockDescriptor *descriptor;</span><br><span class="line">  <span class="comment">// imported variables</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼Œ<em>isa</em> è¿™ä¸ªå­—æ®µå¤§å®¶åº”è¯¥éƒ½å¾ˆç†Ÿæ‚‰ï¼Œå’Œ <code>objc_class</code> ç»“æ„ä½“é‡Œçš„ <em>isa</em> ä¸€æ ·ï¼Œéƒ½æ˜¯æŒ‡å‘å…·ä½“çš„ç±»ã€‚Block ç»“æ„ä½“å¯¹åº”çš„ç±»å¯èƒ½æ˜¯ä»¥ä¸‹ä¸‰ç§ä¸­çš„ä»»æ„ä¸€ç§ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œäº†è§£ï¼Œæœ¬æ–‡ä¸å†ç»§ç»­å±•å¼€ä»‹ç»ã€‚</p>
<ul>
<li>__NSGlobalBlock</li>
<li>__NSMallocBlock</li>
<li>__NSStackBlock</li>
</ul>
<p>FBRetainCycleDetector æºç ä¸­ Block å¯¹è±¡å¯¹åº”çš„ç±»ä¸º <code>FBObjectiveCBlock</code> ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> Object Graph element representing block.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">FBObjectiveCBlock</span> : <span class="title">FBObjectiveCGraphElement</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h2 id="å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯-Block"><a href="#å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯-Block" class="headerlink" title="å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯ Block"></a>å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯ Block</h2><p>å¦‚æœæ˜¯æ™®é€šçš„OCå¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨ <em>[objc class]</em> è·å–å…¶ç±»å‹ã€‚ Block å¯¹è±¡èƒ½ä¸èƒ½ä¹Ÿé€šè¿‡è¿™ç§æ–¹å¼æ¥åˆ¤æ–­å‘¢ï¼Ÿå½“ç„¶æ˜¯å¯ä»¥çš„ï¼ŒBlock å¯¹è±¡æ˜¯ä¸€ç§ç‰¹æ®Šçš„ <strong>OC å¯¹è±¡</strong> ï¼Œå†æ€ä¹ˆç‰¹æ®Šï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªOCå¯¹è±¡ï¼Œæ™®é€šOCå¯¹è±¡èƒ½åšçš„äº‹æƒ…ï¼Œå®ƒä¹Ÿèƒ½åšã€‚ </p>
<p>é—®é¢˜çš„å…³é”®æ˜¯ï¼ŒOC Runtime å¹¶æ²¡æœ‰ç›´æ¥æš´éœ²å‡ºæ‰€è°“çš„ <em>Block ç±»</em> ã€‚ä¸Šé¢æåˆ°è¿‡ï¼Œä¸€ä¸ª Block å¯èƒ½æ˜¯ <code>__NSGlobalBlock</code>ï¼Œ<code>__NSMallocBlock</code>ï¼Œ<code>__NSStackBlock</code> ä¸­çš„ä»»æ„ä¸€ç§ï¼Œä½†æ˜¯è¿™ä¸‰ä¸ªç±»éƒ½æ²¡æœ‰åœ¨OCRuntime ä¸­ç›´æ¥æš´éœ²ã€‚</p>
<h3 id="Block-çš„è¿è¡Œæ—¶ç±»å‹"><a href="#Block-çš„è¿è¡Œæ—¶ç±»å‹" class="headerlink" title="Block çš„è¿è¡Œæ—¶ç±»å‹"></a>Block çš„è¿è¡Œæ—¶ç±»å‹</h3><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬é¦–å…ˆè¦æ‰¾åˆ°ä¸€ä¸ª Block å¯¹è±¡åœ¨è¿è¡Œæ—¶åˆ°åº•æ˜¯ä»€ä¹ˆç±»ã€‚  </p>
<p>FBRetainCycleDetector é€šè¿‡åˆ›å»ºä¸€ä¸ª <em>testBlock</em> å¹¶ä¸æ–­å‘ä¸ŠæŸ¥æ‰¾å…¶ <em>superclass</em> ï¼Œæ¥è·å– Block å¯¹è±¡åœ¨è¿è¡Œæ—¶çš„ â€œåŸºç±»â€ã€‚ </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Class _BlockClass() &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">  <span class="keyword">static</span> Class blockClass;</span><br><span class="line">  <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">    <span class="keyword">void</span> (^testBlock)() = [^&#123;&#125; <span class="keyword">copy</span>];</span><br><span class="line">    blockClass = [testBlock <span class="keyword">class</span>];</span><br><span class="line">    <span class="keyword">while</span>(class_getSuperclass(blockClass) &amp;&amp; class_getSuperclass(blockClass) != [<span class="built_in">NSObject</span> <span class="keyword">class</span>]) &#123;</span><br><span class="line">      blockClass = class_getSuperclass(blockClass);</span><br><span class="line">    &#125;</span><br><span class="line">    [testBlock release];</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> blockClass;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„ï¼š <em>_BlockClass</em> æ–¹æ³•åœ¨æŸ¥æ‰¾ <em>superclass</em> æ—¶ï¼Œå¦‚æœæ‰¾åˆ°äº† <code>NSObject</code>ï¼Œå°±ç›´æ¥ç»ˆæ­¢æŸ¥æ‰¾è¿‡ç¨‹ã€‚å¦åˆ™æ‰¾åˆ°çš„åŸºç±»å°±éƒ½æˆäº† <code>NSObect</code>ã€‚</p>
</blockquote>
<p>å®é™…è¿è¡Œèµ·æ¥ï¼Œå¤§å®¶ä¼šå‘ç°è¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼ä¸º <code>NSBlock</code>ã€‚å…¶å£°æ˜å¦‚ä¸‹ï¼š </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSBlock</span> : <span class="title">NSObject</span> &lt;<span class="title">NSCopying</span>&gt;</span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>è¿™å†æ¬¡å°è¯äº†æˆ‘ä»¬ä¸Šé¢è¯´è¿‡çš„ï¼Œâ€œBlock å¯¹è±¡æ˜¯ä¸€ç§ç‰¹æ®Šçš„OCå¯¹è±¡â€ã€‚Block å¯¹è±¡éƒ½ç»§æ‰¿è‡ª <code>NSBlock</code> ï¼Œ<code>NSBlock</code> åˆæ˜¯ <code>NSObject</code> çš„å­ç±»ã€‚ </p>
<h3 id="Block-ç±»å‹åˆ¤æ–­"><a href="#Block-ç±»å‹åˆ¤æ–­" class="headerlink" title="Block ç±»å‹åˆ¤æ–­"></a>Block ç±»å‹åˆ¤æ–­</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">BOOL</span> FBObjectIsBlock(<span class="keyword">void</span> *object) &#123;</span><br><span class="line">  Class blockClass = _BlockClass();</span><br><span class="line">  </span><br><span class="line">  Class candidate = object_getClass((__bridge <span class="keyword">id</span>)object);</span><br><span class="line">  <span class="keyword">return</span> [candidate isSubclassOfClass:blockClass];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç å°±å¾ˆç®€å•äº†ï¼Œç›´æ¥åˆ¤æ–­å½“å‰å¯¹è±¡çš„ Class æ˜¯ä¸æ˜¯ <code>NSBlock</code> ç±»çš„ subclass å³å¯ã€‚</p>
<h2 id="è·å–-Block-çš„å¼ºå¼•ç”¨å¯¹è±¡"><a href="#è·å–-Block-çš„å¼ºå¼•ç”¨å¯¹è±¡" class="headerlink" title="è·å– Block çš„å¼ºå¼•ç”¨å¯¹è±¡"></a>è·å– Block çš„å¼ºå¼•ç”¨å¯¹è±¡</h2><p>å†å›å¤´çœ‹ Block ç»“æ„ä½“çš„æœ€åï¼Œæœ‰ä¸€è¡Œæ³¨é‡Šï¼š</p>
<blockquote>
<p>// imported variables</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> BlockLiteral &#123;</span><br><span class="line">  <span class="keyword">void</span> *isa;  <span class="comment">// initialized to &amp;_NSConcreteStackBlock or &amp;_NSConcreteGlobalBlock</span></span><br><span class="line">  <span class="keyword">int</span> flags;</span><br><span class="line">  <span class="keyword">int</span> reserved;</span><br><span class="line">  <span class="keyword">void</span> (*invoke)(<span class="keyword">void</span> *, ...);</span><br><span class="line">  <span class="keyword">struct</span> BlockDescriptor *descriptor;</span><br><span class="line">  <span class="comment">// imported variables</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Block å¼•ç”¨çš„å¯¹è±¡ä¼šå­˜æ”¾åœ¨ Block ç»“æ„ä½“çš„æœ€ä¸‹æ–¹ï¼Œè¿™é‡Œä¼¼ä¹æ˜¯ä¸€ä¸ªçªç ´å£ï¼Œç›´æ¥éå† <em>imported variables</em> æ˜¯ä¸æ˜¯å°±å¯ä»¥æ‹¿åˆ°æ‰€æœ‰çš„å¼ºå¼•ç”¨å¯¹è±¡äº†å‘¢ï¼Ÿ</p>
<p>åœ¨ <a href="https://blog.jerrychu.top/2021/01/10/%E8%8E%B7%E5%8F%96OC%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%89%80%E6%9C%89%E5%BC%BA%E5%BC%95%E7%94%A8%E5%AF%B9%E8%B1%A1/">æ™®é€šOCå¯¹è±¡çš„æ‰€æœ‰å¼ºå¼•ç”¨å¯¹è±¡</a> ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬æåˆ°å¼•ç”¨å¯¹è±¡åˆ†ä¸º <strong>å¼ºå¼•ç”¨å¯¹è±¡</strong> å’Œ <strong>å¼±å¼•ç”¨å¯¹è±¡</strong> ï¼Œå¯¹äº Block æ¥è¯´ä¹Ÿæ˜¯ä¸€æ ·ã€‚   </p>
<p>å¯¹äºæ™®é€šOCå¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <em>class_getIvarLayout</em> æ¥åŒºåˆ†å¼ºå¼±å¼•ç”¨å¯¹è±¡ï¼Œä½†æ˜¯ Block å¯¹è±¡å¹¶æ²¡æœ‰ç›´æ¥æä¾› <em>class_getIvarLayout</em> æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ¢ä¸€ç§æ–¹å¼è·å– <em>ivarLayout</em> ã€‚</p>
<h3 id="dispose-helper"><a href="#dispose-helper" class="headerlink" title="dispose_helper"></a>dispose_helper</h3><p>ç»§ç»­çœ‹ Block ç»“æ„ä½“ï¼Œå…¶æœ‰ä¸€ä¸ª <code>BlockDescriptor</code> ç»“æ„ä½“ï¼Œç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> BlockDescriptor &#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> reserved;                <span class="comment">// NULL</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> size;</span><br><span class="line">	<span class="comment">// optional helper functions</span></span><br><span class="line">	<span class="keyword">void</span> (*copy_helper)(<span class="keyword">void</span> *dst, <span class="keyword">void</span> *src); <span class="comment">// IFF (1&lt;&lt;25)</span></span><br><span class="line">	<span class="keyword">void</span> (*dispose_helper)(<span class="keyword">void</span> *src);         <span class="comment">// IFF (1&lt;&lt;25)</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *signature;                     <span class="comment">// IFF (1&lt;&lt;30)</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼Œ<em>size</em> å­—æ®µè¡¨ç¤º Block æŒæœ‰çš„æ‰€æœ‰å¯¹è±¡çš„å¤§å°ï¼Œé€šè¿‡è¿™ä¸ªå­—æ®µæˆ‘ä»¬èƒ½æ‹¿åˆ° Block æŒæœ‰çš„å¯¹è±¡æ€»æ•°ï¼ˆåŒ…æ‹¬å¼ºå¼•ç”¨å’Œå¼±å¼•ç”¨ï¼‰ã€‚</p>
<p>åœ¨è¿™ä¸ªç»“æ„ä½“ä¸­è¿˜æœ‰ä¸¤ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œ <em>copy_helper</em> å’Œ <em>dispose_helper</em> ã€‚ <em>copy_helper</em> ç”¨äº Block çš„æ‹·è´ï¼Œè€Œ  <em>dispose_helper</em> ç”¨äº Block çš„ææ„ã€‚<br>Block åœ¨ææ„æ—¶ä¼šè°ƒç”¨ <em>dispose_helper</em> ï¼Œå¯¹æ‰€æœ‰å¼ºå¼•ç”¨å¯¹è±¡å‘é€ <em>release</em> æ¶ˆæ¯ï¼Œä»¥é”€æ¯å¼ºå¼•ç”¨å¯¹è±¡ã€‚å¼±å¼•ç”¨å¯¹è±¡æ­¤æ—¶è‡ªç„¶ä¸ä¼šæ”¶åˆ° <em>release</em> æ¶ˆæ¯ã€‚</p>
<p>FBRetainCycleDetector æ­£æ˜¯åˆ©ç”¨è¿™ä¸ªåŸç†ï¼Œæ¥è·å– Block çš„æ‰€æœ‰å¼ºå¼•ç”¨å¯¹è±¡ã€‚</p>
<h3 id="å‘é€-æ¥æ”¶-release-æ¶ˆæ¯"><a href="#å‘é€-æ¥æ”¶-release-æ¶ˆæ¯" class="headerlink" title="å‘é€/æ¥æ”¶ release æ¶ˆæ¯"></a>å‘é€/æ¥æ”¶ release æ¶ˆæ¯</h3><p>Block åœ¨ææ„æ—¶ä¼šè°ƒç”¨ <em>dispose_helper</em> ï¼Œå¯¹æ‰€æœ‰å¼ºå¼•ç”¨å¯¹è±¡å‘é€ <em>release</em> æ¶ˆæ¯ã€‚é‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡ <em>dispose_helper</em> æ–¹æ³•ï¼Œçœ‹çœ‹å“ªäº›å¯¹è±¡æ”¶åˆ°äº† <em>release</em> æ¶ˆæ¯ï¼Œè¿™äº›å¯¹è±¡å°±æ˜¯è¢«å¼ºå¼•ç”¨çš„å¯¹è±¡äº†ã€‚  </p>
<p>é—®é¢˜æ¥äº†ï¼Œæ€ä¹ˆçŸ¥é“å“ªä¸ªå¯¹è±¡æ‰§è¡Œäº† <em>release</em> æ–¹æ³•å‘¢ï¼Ÿéš¾é“è¦æŠŠæ‰€æœ‰å¯¹è±¡çš„ <em>release</em> æ–¹æ³•éƒ½ hook æ‰ï¼Ÿè¿™æ ·è‚¯å®šæ˜¯ä¸ç°å®çš„ã€‚è€Œä¸”ï¼Œæˆ‘ä»¬åªæ˜¯æƒ³çŸ¥é“å“ªäº›å¯¹è±¡è¢«å¼ºå¼•ç”¨äº†ï¼Œå¹¶ä¸æƒ³æŠŠè¿™äº›å¯¹è±¡çœŸæ­£é”€æ¯æ‰ã€‚å¦‚æœçœŸé”€æ¯æ‰äº†ï¼Œæ•´ä¸ª Block è‚¯å®šä¹±æˆä¸€é”…ç²¥äº†ğŸ˜‚ã€‚  </p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ª <em>è™šå‡çš„å¯¹è±¡</em> ï¼Œç”¨æ¥æ¥æ”¶ <em>release</em> æ¶ˆæ¯ã€‚åœ¨ FBRetainCycleDetector çš„æºç ä¸­ï¼Œ<code>FBBlockStrongRelationDetector</code> å°±æ˜¯è¿™ä¸ª <em>è™šå‡çš„å¯¹è±¡</em> ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">FBBlockStrongRelationDetector</span></span></span><br><span class="line">- (<span class="keyword">oneway</span> <span class="keyword">void</span>)release &#123;</span><br><span class="line">  _<span class="keyword">strong</span> = <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">oneway</span> <span class="keyword">void</span>)trueRelease &#123;</span><br><span class="line">  [<span class="keyword">super</span> release];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p><code>FBBlockStrongRelationDetector</code> å¯¹è±¡åœ¨æ¥æ”¶åˆ° <em>release</em> æ¶ˆæ¯æ—¶ï¼Œåªæ˜¯å°† <em>_strong</em> æ ‡è®°ä¸º <code>YES</code>ï¼ŒçœŸæ­£çš„é”€æ¯æ˜¯åœ¨ <em>trueRelease</em> æ–¹æ³•ä¸­å®Œæˆçš„ã€‚</p>
<h3 id="æ”¶é›†å¼ºå¼•ç”¨å¯¹è±¡"><a href="#æ”¶é›†å¼ºå¼•ç”¨å¯¹è±¡" class="headerlink" title="æ”¶é›†å¼ºå¼•ç”¨å¯¹è±¡"></a>æ”¶é›†å¼ºå¼•ç”¨å¯¹è±¡</h3><p>é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬å·²ç»èƒ½å¤Ÿï¼š</p>
<ul>
<li>é€šè¿‡è§£æ Block ç»“æ„ä½“æ•°æ®å’Œ <code>BlockDescriptor</code> ç»“æ„ä½“çš„ <em>size</em> å­—æ®µï¼Œè·å–åˆ°æ‰€æœ‰å¼•ç”¨å¯¹è±¡åˆ—è¡¨ã€‚</li>
<li>é€šè¿‡æ‰‹åŠ¨æ‰§è¡Œ <code>BlockDescriptor</code> ç»“æ„ä½“çš„ <em>dispose_helper</em> ï¼Œè·å–æ‰€æœ‰å¼ºå¼•ç”¨å¯¹è±¡åœ¨å¯¹è±¡åˆ—è¡¨ä¸­çš„ä½ç½®ã€‚</li>
</ul>
<p>é‚£æœ€åä¸€æ­¥å°±å¾ˆæ˜æ˜¾ï¼Œä¹Ÿå¾ˆç®€å•äº†ï¼š</p>
<ul>
<li>æ”¶é›†æ‰€æœ‰å¼ºå¼•ç”¨å¯¹è±¡ã€‚</li>
</ul>
<p>å…¶å®ï¼ŒæŸ¥æ‰¾ Block å¼ºå¼•ç”¨å¯¹è±¡å’ŒæŸ¥æ‰¾æ™®é€šOCå¯¹è±¡çš„å¼ºå¼•ç”¨å¯¹è±¡ï¼Œåœ¨æ€æƒ³ä¸Šè¿˜æ˜¯éå¸¸ç›¸ä¼¼çš„ã€‚éƒ½éœ€è¦å…ˆè·å¾—æ‰€æœ‰å¯¹è±¡åˆ—è¡¨ï¼Œå†ç­›é€‰å‡ºå¼ºå¼•ç”¨å¯¹è±¡ã€‚åªä¸è¿‡æ™®é€šOCå¯¹è±¡ç­›é€‰å¼ºå¼•ç”¨å¯¹è±¡éå¸¸æ–¹ä¾¿ï¼Œå¯ä»¥ç›´æ¥è·å–åˆ° <em>ivarLayout</em> ï¼ŒBlock å¯¹è±¡è¦éº»çƒ¦å¾ˆå¤šã€‚ </p>
<h3 id="æºç è§£è¯»"><a href="#æºç è§£è¯»" class="headerlink" title="æºç è§£è¯»"></a>æºç è§£è¯»</h3><p><code>FBObjectiveCBlock</code> ç±»ä¸­æä¾›äº†å¦‚ä½•è·å– Block å¯¹è±¡çš„æ‰€æœ‰å¼ºå¼•ç”¨å¯¹è±¡çš„æºç ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSSet</span> *)allRetainedObjects &#123;</span><br><span class="line">  <span class="comment">// 1. æ·»åŠ ä½œä¸ºæ™®é€šOCå¯¹è±¡çš„æ‰€æœ‰å¼ºå¼•ç”¨å¯¹è±¡ï¼Œè§ *FBObjectiveCObject.m*</span></span><br><span class="line">  <span class="built_in">NSMutableArray</span> *results = [[[<span class="keyword">super</span> allRetainedObjects] allObjects] mutableCopy];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Grab a strong reference to the object, otherwise it can crash while doing</span></span><br><span class="line">  <span class="comment">// nasty stuff on deallocation</span></span><br><span class="line">  __attribute__((objc_precise_lifetime)) <span class="keyword">id</span> anObject = <span class="keyword">self</span>.object;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. è·å–æ‰€æœ‰ Block å¼ºå¼•ç”¨çš„å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">void</span> *blockObjectReference = (__bridge <span class="keyword">void</span> *)anObject;</span><br><span class="line">  <span class="built_in">NSArray</span> *allRetainedReferences = FBGetBlockStrongReferences(blockObjectReference);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">id</span> object <span class="keyword">in</span> allRetainedReferences) &#123;</span><br><span class="line">    FBObjectiveCGraphElement *element = FBWrapObjectGraphElement(<span class="keyword">self</span>, object, <span class="keyword">self</span>.configuration);</span><br><span class="line">    <span class="keyword">if</span> (element) &#123;</span><br><span class="line">      [results addObject:element];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> [<span class="built_in">NSSet</span> setWithArray:results];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼Œ <em>FBGetBlockStrongReferences</em> æ–¹æ³•çš„æºç åœ¨ <em>FBBlockStrongLayout.m</em> ä¸­ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æœ‰åˆ å‡</span></span><br><span class="line"><span class="built_in">NSArray</span> *FBGetBlockStrongReferences(<span class="keyword">void</span> *block) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="built_in">NSMutableArray</span> *results = [<span class="built_in">NSMutableArray</span> new];</span><br><span class="line">  <span class="comment">// ç¡®å®šå¼•ç”¨å¯¹è±¡ä¸­å“ªäº›ä¸ºå¼ºå¼•ç”¨</span></span><br><span class="line">  <span class="keyword">void</span> **blockReference = block;</span><br><span class="line">  <span class="built_in">NSIndexSet</span> *strongLayout = _GetBlockStrongLayout(block);</span><br><span class="line">  [strongLayout enumerateIndexesUsingBlock:^(<span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">    <span class="keyword">void</span> **reference = &amp;blockReference[idx];</span><br><span class="line">    <span class="keyword">if</span> (reference &amp;&amp; (*reference)) &#123;</span><br><span class="line">      <span class="keyword">id</span> object = (<span class="keyword">id</span>)(*reference);</span><br><span class="line">      <span class="keyword">if</span> (object) &#123;</span><br><span class="line">        [results addObject:object];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;];</span><br><span class="line">  <span class="keyword">return</span> [results autorelease];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSIndexSet</span> *_GetBlockStrongLayout(<span class="keyword">void</span> *block) &#123;</span><br><span class="line">  <span class="keyword">struct</span> BlockLiteral *blockLiteral = block; </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// è·å– dispose_helper å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">  <span class="keyword">void</span> (*dispose_helper)(<span class="keyword">void</span> *src) = blockLiteral-&gt;descriptor-&gt;dispose_helper;</span><br><span class="line">  <span class="comment">// è®¡ç®—å¼•ç”¨å¯¹è±¡ä¸ªæ•°</span></span><br><span class="line">  <span class="keyword">const</span> size_t ptrSize = <span class="keyword">sizeof</span>(<span class="keyword">void</span> *);</span><br><span class="line">  <span class="keyword">const</span> size_t elements = (blockLiteral-&gt;descriptor-&gt;size + ptrSize - <span class="number">1</span>) / ptrSize;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºâ€œè™šå‡çš„å¯¹è±¡â€ï¼Œç”¨äºæ¥æ”¶ release æ¶ˆæ¯</span></span><br><span class="line">  <span class="keyword">void</span> *obj[elements];</span><br><span class="line">  <span class="keyword">void</span> *detectors[elements];</span><br><span class="line">  <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; elements; ++i) &#123;</span><br><span class="line">    FBBlockStrongRelationDetector *detector = [FBBlockStrongRelationDetector new];</span><br><span class="line">    obj[i] = detectors[i] = detector;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ‰§è¡Œ dispose_helper æ–¹æ³•ï¼Œè§¦å‘å¼ºå¼•ç”¨å¯¹è±¡æ‰€åœ¨çš„ç´¢å¼•ä½ç½®çš„ FBBlockStrongRelationDetector æ‰§è¡Œ release</span></span><br><span class="line">  <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">    dispose_helper(obj);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ”¶é›†å¼ºå¼•ç”¨å¯¹è±¡æ‰€åœ¨çš„ç´¢å¼•</span></span><br><span class="line">  <span class="built_in">NSMutableIndexSet</span> *layout = [<span class="built_in">NSMutableIndexSet</span> indexSet];</span><br><span class="line">  <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; elements; ++i) &#123;</span><br><span class="line">    FBBlockStrongRelationDetector *detector = (FBBlockStrongRelationDetector *)(detectors[i]);</span><br><span class="line">    <span class="keyword">if</span> (detector.isStrong) &#123;</span><br><span class="line">      [layout addIndex:i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Destroy detectors</span></span><br><span class="line">    [detector trueRelease];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> layout;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>FBRetainCycleDetector å°†OCå¯¹è±¡åˆ’åˆ†ä¸º3ç±»ï¼Œåˆ†åˆ«ä¸ºï¼š</p>
<ul>
<li>FBObjectiveCObject</li>
<li>FBObjectiveCNSCFTimer</li>
<li>FBObjectiveCBlock</li>
</ul>
<p>æœ¬ç³»åˆ—çš„ä¸‰ç¯‡æ–‡ç« åˆ†åˆ«ä»‹ç»äº†å¯¹è¿™3ç±»å¯¹è±¡å¦‚ä½•è·å–å…¶æ‰€æœ‰å¼ºå¼•ç”¨å¯¹è±¡ã€‚æ±‡æ€»èµ·æ¥ï¼Œå°±æ˜¯ FBRetainCycleDetector æŸ¥æ‰¾OCå¯¹è±¡çš„æ‰€æœ‰å¼ºå¼•ç”¨å¯¹è±¡çš„åŸºæœ¬åŸç†ã€‚çŸ¥é“æ¯ä¸ªOCå¯¹è±¡çš„æ‰€æœ‰å¼ºå¼•ç”¨å¯¹è±¡åï¼Œå°±èƒ½å¤Ÿç”Ÿæˆæ¯ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨å…³ç³»å›¾ï¼Œç»§ç»­æŒ‰å›¾ç´¢éª¥ï¼Œå°±èƒ½å¤Ÿæ£€æµ‹åˆ°æ˜¯å¦å­˜åœ¨å¾ªç¯å¼•ç”¨é“¾ã€‚  </p>
<p><a href="https://github.com/facebook/FBRetainCycleDetector" target="_blank" rel="noopener">FBRetainCycleDetector</a> æ˜¯ä¸€ä¸ªéå¸¸ä¼˜ç§€çš„å¼€æºé¡¹ç›®ï¼Œå°¤å…¶é€‚åˆç”¨æ¥å­¦ä¹  OC Runtime çŸ¥è¯†ï¼Œäº†è§£ OC å¯¹è±¡åœ¨è¿è¡Œæ—¶çš„ç»“æ„ï¼Œé¡ºä¾¿æŒæ¡ä¸€äº› â€œé»‘ç§‘æŠ€â€ ï¼Œå¼ºçƒˆå»ºè®®å¤§å®¶é˜…è¯»å…¶æºç ã€‚</p>
<p>å‰ä¸¤ç¯‡æ–‡ç« é“¾æ¥ï¼š</p>
<ul>
<li><a href="https://blog.jerrychu.top/2021/01/10/%E8%8E%B7%E5%8F%96OC%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%89%80%E6%9C%89%E5%BC%BA%E5%BC%95%E7%94%A8%E5%AF%B9%E8%B1%A1/">è·å–æ™®é€šOCå¯¹è±¡çš„æ‰€æœ‰å¼ºå¼•ç”¨å¯¹è±¡</a> </li>
<li><a href="https://blog.jerrychu.top/2021/01/16/%E8%8E%B7%E5%8F%96OC%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%89%80%E6%9C%89%E5%BC%BA%E5%BC%95%E7%94%A8%E5%AF%B9%E8%B1%A12/">è·å–Timerå¯¹è±¡çš„æ‰€æœ‰å¼ºå¼•ç”¨å¯¹è±¡</a></li>
</ul>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="https://draveness.me/block-retain-object/" target="_blank" rel="noopener">https://draveness.me/block-retain-object/</a></li>
<li><a href="https://github.com/facebook/FBRetainCycleDetector" target="_blank" rel="noopener">https://github.com/facebook/FBRetainCycleDetector</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/iOS/" rel="tag"># iOS</a>
              <a href="/tags/Performance/" rel="tag"># Performance</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/01/16/%E8%8E%B7%E5%8F%96OC%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%89%80%E6%9C%89%E5%BC%BA%E5%BC%95%E7%94%A8%E5%AF%B9%E8%B1%A12/" rel="prev" title="è·å–OCå¯¹è±¡çš„æ‰€æœ‰å¼ºå¼•ç”¨å¯¹è±¡ï¼ˆäºŒï¼‰">
      <i class="fa fa-chevron-left"></i> è·å–OCå¯¹è±¡çš„æ‰€æœ‰å¼ºå¼•ç”¨å¯¹è±¡ï¼ˆäºŒï¼‰
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/01/30/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E6%A3%80%E6%B5%8B%E5%B7%A5%E5%85%B7-JCLeaksFinder/" rel="next" title="å†…å­˜æ³„æ¼æ£€æµ‹å·¥å…· - JCLeaksFinder">
      å†…å­˜æ³„æ¼æ£€æµ‹å·¥å…· - JCLeaksFinder <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Block-åŸºç¡€"><span class="nav-number">1.</span> <span class="nav-text">Block åŸºç¡€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯-Block"><span class="nav-number">2.</span> <span class="nav-text">å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯ Block</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Block-çš„è¿è¡Œæ—¶ç±»å‹"><span class="nav-number">2.1.</span> <span class="nav-text">Block çš„è¿è¡Œæ—¶ç±»å‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Block-ç±»å‹åˆ¤æ–­"><span class="nav-number">2.2.</span> <span class="nav-text">Block ç±»å‹åˆ¤æ–­</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#è·å–-Block-çš„å¼ºå¼•ç”¨å¯¹è±¡"><span class="nav-number">3.</span> <span class="nav-text">è·å– Block çš„å¼ºå¼•ç”¨å¯¹è±¡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dispose-helper"><span class="nav-number">3.1.</span> <span class="nav-text">dispose_helper</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å‘é€-æ¥æ”¶-release-æ¶ˆæ¯"><span class="nav-number">3.2.</span> <span class="nav-text">å‘é€&#x2F;æ¥æ”¶ release æ¶ˆæ¯</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ”¶é›†å¼ºå¼•ç”¨å¯¹è±¡"><span class="nav-number">3.3.</span> <span class="nav-text">æ”¶é›†å¼ºå¼•ç”¨å¯¹è±¡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æºç è§£è¯»"><span class="nav-number">3.4.</span> <span class="nav-text">æºç è§£è¯»</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ€»ç»“"><span class="nav-number">4.</span> <span class="nav-text">æ€»ç»“</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å‚è€ƒ"><span class="nav-number">5.</span> <span class="nav-text">å‚è€ƒ</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">JerryChu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">31</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JerryChu</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
